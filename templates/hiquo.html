<!DOCTYPE html>
 <html lang="ja">
   <head>
     <meta charset="utf-8">
     <meta name="robots" content="noindex,nofollow">
     <title>{{ video_title }} New-Instance</title>
     <link rel="icon" href="/img/logo/favicon.ico">
     
     <link rel="stylesheet" href="/css/pure-min.css">
     <link rel="stylesheet" href="/css/grids-responsive-min.css">
     <link rel="stylesheet" href="/css/ionicons.min.css">
     <link rel="stylesheet" href="/css/default.css">
     <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" />
     
     <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&icon_names=thumb_up" />
     
     <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
     <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
     <script src="/js/utils/utils.js"></script>
     <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
     <link rel="preload" as="audio" href="{{ audio_url }}">
     <style>  #audio {
         display: none;
     }</style>
     <script>
       // クエリパラメータから値を取得するヘルパー関数
       function getQueryValue(param) {
         const urlParams = new URLSearchParams(window.location.search);
         return urlParams.get(param);
       }
       
       // クッキーから値を取得するヘルパー関数
       function getCookie(name) {
         const nameEQ = name + "=";
         const ca = document.cookie.split(';');
         for(let i=0; i < ca.length; i++) {
           let c = ca[i];
           while (c.charAt(0) === ' ') c = c.substring(1, c.length);
           if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
         }
         return null;
       }
       
       // 秒数をHMS形式（時間:分:秒）に変換するヘルパー関数
       function secToHMS(seconds) {
         const h = Math.floor(seconds / 3600);
         const m = Math.floor((seconds % 3600) / 60);
         const s = seconds % 60;
         return [h, m, s]
           .map(v => v < 10 ? "0" + v : v) // 1桁の場合は先頭に0を追加
           .filter((v, i) => v !== "00" || i > 0) // 時間が00の場合は非表示
           .join(":");
       }
     </script>
   </head>
   <body class="no-theme">
     <span id="dark_mode_pref" style="display:none"></span>
     <div class="pure-g">
       <div class="pure-u-1 pure-u-md-2-24"></div>
       <div id="contents" class="pure-u-1 pure-u-md-20-24">
         <div class="pure-g navbar h-box">
           <div class="pure-u-1 pure-u-md-12-24 searchbar">
             <a href="javascript:location.replace('/')">ホーム</a><br>
             
             <form class="pure-form" action="/search" method="get">
               <fieldset>
                 <input id="searchbox" name="q" type="search" placeholder="検索" value="" title="検索" autocomplete="on" autocorrect="on" autocapitalize="none" spellcheck="false">
               </fieldset>
             </form>
           </div>
         </div>
         <div id="player-container" class="h-box">
           <video id="player" class="on-video_player video-js player-style-invidious" loadedmetadata="settime()" controls="" playsinline="" loop="" 
             style="outline:none;width:100%;background-color:#000;" 
             poster="{% if proxy == 'True' %}/thumbnail?v={{ videoid }}{% else %}https://img.youtube.com/vi/{{ videoid }}/0.jpg{% endif %}">
             
             {# もし高画質ストリームが取得できていれば、そちらを優先的に追加 #}
             {% if highstream_url %}
             <source id="videosrc" src="{{ highstream_url }}" type="video/webm">
             {% endif %}
             {# もし別途音声ストリームが取得できていれば、同時に追加（※単体で再生されるわけではなく、MSE等で合成する必要がある場合は専用の再生ロジックが必要） #}
             {% if audio_url %}
             <source src="{{ audio_url }}" type="audio/mp4">
             {% endif %}
             {# 既存の通常動画URLも引き続き追加 #}
             {% for videourl in videourls %}
             <source class="player-source" src="{{ videourl }}">
             {% endfor %}
             <p id="video_info">お使いのブラウザは動画の再生に対応していません。</p>
           </video>
           <iframe id="embed-player" style="display:none; width:100%; aspect-ratio: 16/9; border:none;" allowfullscreen></iframe>
         </div>
          <audio id="audio" controls>
          <source src= "{{ videourls[0] }}" type="audio/mp3">
 </audio>
         
         <div class="h-box">
           <h1>{{ video_title }}</h1>
           <p style="display: inline-block; margin-right: 10px; vertical-align: super;">{{ view_count }}回視聴</p>
           <div style="display: inline-block;">
             <span class="material-symbols-outlined" style="display: inline-block; padding-right: 5px;">thumb_up</span>
             <p style="display: inline-block; vertical-align: super;">{{ like_count }}</p>
           </div>
           <p id="player_current_time" style="display: inline-block; margin-left: 10px; vertical-align: super;"></p>
           <p style="display: inline-block; vertical-align: super;">/ {{ length_text }}</p>
         </div>
         <br>
         <div class="pure-g">
           <div class="pure-u-1 pure-u-lg-1-5">
             <button id="restartBtn">音を合わせる</button><br>
             <a href="{{ highstream_url }}" download="{{ video_title }}">ダウンロード</a><br>
                        <a href="javascript:{navigator.share({title: '現時点の動画を共有', text: '{{ video_title }}', url: location.origin + '/watch?v={{ videoid }}' + '&t=' + Math.floor(document.getElementById('player').currentTime)})}">現時点の動画を共有</a><br>
                        <a href="javascript:{navigator.share({title: '動画を共有', text: '{{ video_title }}', url: location.href})}">動画を共有</a><br>
                        <a href="#" id="toggle-embed-player">埋め込みで再生</a><br>
             <a href="javascript:location.replace('/w?v={{ videoid }}')">デフォルトで視聴する</a><br>
            <a href="javascript:location.replace('/watch?v={{ videoid }}')">再読込み</a>
             
             
             <hr>
           </div>
           <div class="pure-u-1 pure-u-lg-3-5">
             <div class="h-box">
               <a href="/channel/{{ author_id }}" style="display: inline-block; width: fit-content; width: -moz-fit-content">
                 <div class="channel-profile">
                   <img src="{{ author_icon }}">
                   <span id="channel-name">{{ author }}</span>
                 </div>
               </a>
               <p>チャンネル登録者数: {{ subscribers_count }}人</p>
               <div id="description-box">
                 <div id="descriptionWrapper">{{ description | safe}}</div>
               </div>
               <hr>
               <div id="comments"></div>
             </div>
           </div>
           <div class="pure-u-1 pure-u-lg-1-5">
             <label for="autonextpage">自動で次の動画に遷移<input id="autonextpage" type="checkbox" onchange="changeAutoNextPage(this)"></label><br>
             <label for="loop">ループ再生<input id="loop" type="checkbox" onchange="changeLoop(this)"></label>
             {% for rec_video in recommended_videos %}
             <a href="/watch?v={{ rec_video['video_id'] }}">
               <div class="thumbnail">
                 <img loading="lazy" class="thumbnail" src="{% if proxy == 'True' %}/thumbnail?v={{ rec_video['video_id'] }}{% else %}https://img.youtube.com/vi/{{ rec_video['video_id'] }}/0.jpg{% endif %}">
                 <p class="length">{{ rec_video["length_text"] }}</p>
               </div>
               <p style="width:100%;">{{ rec_video["title"] }}</p>
             </a>
             <p>{{ rec_video["view_count_text"] }}回視聴</p>
             <a href="/channel/{{ rec_video['authorId'] }}">{{ rec_video["author"] }}</a>
             {% endfor %}
           </div>
         </div>
       </div>
     </div>
     <div class="pure-u-1 pure-u-md-2-24"></div>
     
     <script>
       const xhr = new XMLHttpRequest();
       xhr.open("GET", "/comments?v=" + getQueryValue('v'));
       xhr.onload = function () {      
         if (xhr.status == 200) {
           const comments_div = document.getElementById('comments');
           comments_div.innerHTML = xhr.responseText;
           const comments_a_tags = comments_div.getElementsByTagName('a');
           for(let i = 0; i < comments_a_tags.length; i++) {
             const jump_time = comments_a_tags[i].getAttribute('data-jump-time')
             if(jump_time) {
               comments_a_tags[i].addEventListener('click', function(e) {
                 e.preventDefault();
                 player.currentTime = jump_time;
               })
             }
           }
         } else { 
           document.getElementById('comments').innerHTML = "コメントの読み込みに失敗しました。再読み込み等をお試し下さい。"; 
         }
       };
       xhr.send();
       
       let player = document.getElementById("player");
       let embedPlayer = document.getElementById("embed-player");
       let toggleEmbedButton = document.getElementById("toggle-embed-player");
       let currentPlayingMode = 'standard'; // 'standard' or 'embed'
       
       document.cookie = "yuki=True; path=/; max-age=10800;";
       const haveLoopCookie = getCookie("loop") === 'true' ? true : false;
       player.loop = haveLoopCookie;
       document.getElementById("loop").checked = haveLoopCookie;
       document.getElementById("autonextpage").checked = getCookie("autonextpage") === 'true' ? true : false;
       
       function changeAutoNextPage(checkbox) {      
         document.cookie =  `autonextpage=${checkbox.checked}; path=/; max-age=10800;`;
       }
       
       function autoNextPage() {
         const enable_autoNextPage = document.getElementById('autonextpage').checked;
         document.cookie = `autonextpage=${enable_autoNextPage}; max-age=10800;`;
         if (enable_autoNextPage) {
           setTimeout(() => {
             location.replace("/watch?v={{ recommended_videos[0]['video_id'] }}");
           }, 5000);
         }
       }
       player.addEventListener('ended', autoNextPage);
       
       function changeLoop(checkbox) {      
         const enable_loop = checkbox.checked;
         document.getElementById("player").loop = enable_loop;
         document.cookie = `loop=${enable_loop}; path=/; max-age=10800;`;
       }
       
       document.getElementById("player").currentTime = getQueryValue('t') || 0;
       
       function keydown(key) {                  
         if (key.keyCode == 32 || key.keyCode == 75) {
           const v = document.getElementById("player");
           if (v.paused === true) {
             v.play();
           } else {
             v.pause();
           }
         }
       }
       window.addEventListener('keydown', keydown);
       
       const description_a_tags = document.getElementById('descriptionWrapper').getElementsByTagName('a');
       for(let i = 0; i < description_a_tags.length; i++) {
         const jump_time = description_a_tags[i].getAttribute('data-jump-time');
         if(jump_time) {
           description_a_tags[i].addEventListener('click', function(e) {
             e.preventDefault();
             player.currentTime = jump_time;
           });
         }
       }
       
       player.style.maxHeight = document.documentElement.clientHeight * 0.8 + "px";
       embedPlayer.style.maxHeight = document.documentElement.clientHeight * 0.8 + "px";
       
       let info = document.getElementById('video_info');
       
       let reload_button_elm = document.createElement('button');
       reload_button_elm.setAttribute('onclick', 'location.replace(location.href);');
       reload_button_elm.innerHTML = 'リロード';
       
       setTimeout(() => {
         if(player.networkState === 3 && currentPlayingMode === 'standard'){
           let update_api_xhr = new XMLHttpRequest();
           update_api_xhr.open("GET", "/api/video/next"); 
           update_api_xhr.send();
           
           info.innerHTML = '動画の読み込みに失敗しました。再読み込み等をお試し下さい。<br>';
           info.innerHTML += '過度な再読み込みはインスタンスに負荷がかかり、短期間で使用不能に陥ることや、動画等の読み込みが出来なくなることが考えられますのでご遠慮下さい。';
           player.after(reload_button_elm);
           player.after(info);
           player.remove();
         }
       }, 1000);
       
       (function updateDisplayCurrentTime() {
         setTimeout(() => {
           const player = document.getElementById('player');
           const current_time_elem = document.getElementById('player_current_time');
           if(player) {
             current_time_elem.textContent = secToHMS(player.currentTime | 0);
           } else {
             current_time_elem.textContent = 'Error';
           }
           updateDisplayCurrentTime();
         }, 100);
       })();
       
       // 埋め込みプレーヤー切り替えボタンのイベントリスナー
       toggleEmbedButton.addEventListener('click', function(e) {
         e.preventDefault();
         const currentTime = (currentPlayingMode === 'standard' && player) ? player.currentTime : 0;
         
         if (currentPlayingMode === 'embed') {
           // 標準動画プレーヤーに戻す
           player.style.display = 'block';
           embedPlayer.style.display = 'none';
           player.currentTime = currentTime;
           player.play();
           currentPlayingMode = 'standard';
           toggleEmbedButton.textContent = '埋め込みで再生';
         } else {
           // 埋め込みプレーヤーに切り替え
           player.style.display = 'none';
           embedPlayer.style.display = 'block';
           embedPlayer.src = `https://www.youtube-nocookie.com/embed/{{ videoid }}?autoplay=1&start=${Math.floor(currentTime)}`;
           player.pause();
           currentPlayingMode = 'embed';
           toggleEmbedButton.textContent = '通常の再生に戻す';
         }
       });
     </script>
     <script>
       $('#searchbox').autocomplete({
         source: function (request, response) {      
           const url = "/suggest?keyword=" + request.term;
           const xhr = new XMLHttpRequest();
           xhr.open("GET", url);
           xhr.onload = function () {      
             response(JSON.parse(xhr.responseText));
           };
           xhr.send();
         }, delay: 300
       });
     </script>
     <script>
     $(document).ready(function(){
           // 動画と音声の要素を取得
           var video = document.getElementById('player');
           var audio = document.getElementById('audio');
       
           // 動画再生時、現在の再生位置に合わせた上で音声も再生する
           video.addEventListener('play', function(){
             audio.currentTime = video.currentTime;
             audio.play();
           });
       
           // 動画一時停止時、音声も一時停止する
           video.addEventListener('pause', function(){
             audio.pause();
           });
       
           // ユーザーが動画をシークしたとき、音声の再生位置も合わせる
           video.addEventListener('seeked', function(){
             audio.currentTime = video.currentTime;
           });
           video.addEventListener('seeked', () => {
               if (video.currentTime === 0) {
                 audio.currentTime = 0;
               }
           });
         });
       </script>
       <script>
         $(document).ready(function(){
           // 動画要素を取得
           var video = document.getElementById('player');
           
           // ボタンがクリックされたときの処理（元の処理）
           $("#startButton").on("click", function(){
             // 動画の再生位置を0:00に設定し再生
             video.currentTime = 0;
             video.play();
           });
         });
       </script>
       <script>
         document.addEventListener('DOMContentLoaded', function() {
           var audioElem = document.getElementById('audio');
           if (audioElem) {
             audioElem.load();
             console.log('Audio preload called');
           }
         });
       </script>
       
       <script>
         $(document).ready(function(){
           // 動画と音声の要素を取得
           var video = document.getElementById('player');
           var audio = document.getElementById('audio');
           
           video.addEventListener('play', () => {
             audio.play().catch(error => {
               console.error("オーディオの再生エラー:", error);
             });
           });
           
           video.addEventListener('pause', () => {
             audio.pause();
             audio.currentTime = video.currentTime;
           });
           
           video.addEventListener('ended', () => {
             audio.pause();
             audio.currentTime = 0; 
           });
           
           video.addEventListener('seeked', () => {
             video.pause();
             audio.pause();
             audio.currentTime = video.currentTime;
             video.play();
             audio.play();
           });
         });
       </script>
       <script>
         video.addEventListener('loadedmetadata', () => {
           video.play().catch(error => console.error("動画の再生エラー:", error));
         });
         video.addEventListener('play', () => {
           audio.play().catch(error => console.error("オーディオの再生エラー:", error));
         });
       </script>
       <script>
         document.getElementById('reloadButton').addEventListener('click', function() {
           const video = document.getElementById('player');
           const audio = document.getElementById('audio');
           
           video.load();
           audio.load();
         });
       </script>
       <script>
         // ボタン要素を取得
         const restartBtn = document.getElementById("restartBtn");
         
         // ボタンにクリックイベントリスナーを設定
         restartBtn.addEventListener("click", () => {
           // audio要素を取得
           const audioPlayer = document.getElementById("audio");
           const videoPlayer = document.getElementById("player");
           
           // 再生位置を先頭(0秒)にリセット
           audio.currentTime = 0;
           video.currentTime = 0;
           
           // 音声を再生（再起動）
           audio.play();
         });
       </script>
       <script>
         function addToHistory() {
           // サーバーサイドのテンプレートで動的に値を埋め込む
           const videoData = {
             video_id: "{{ videoid }}",  // 動画ID
             // プロキシ有無に応じたサムネイルURL（テンプレートエンジンの構文例）
             thumbnail: "{% if proxy == 'True' %}/thumbnail?v={{ videoid }}{% else %}https://img.youtube.com/vi/{{ videoid }}/0.jpg{% endif %}",
             length: "{{ length_text }}",           // 動画の長さ（例："0:05:24"）
             title: "{{ video_title }}",            // 動画タイトル
             channel: "{{ author }}",               // チャンネル名
             channel_id: "{{ author_id }}",         // チャンネルID
             view_count: "{{ view_count }}",        // 再生回数（例："6M views"）
             published: "{{ published_date }}"      // 公開期間（例："3 years ago"）
           };
           
           // localStorage から既存の履歴を取得（なければ空の配列）
           let history = localStorage.getItem('watchHistory');
           history = history ? JSON.parse(history) : [];
           
           // 同じ動画がすでにあれば削除（最新の履歴を先頭に追加するため）
           history = history.filter(item => item.video_id !== videoData.video_id);
           
           // 配列の先頭に追加（最新履歴を上に表示）
           history.unshift(videoData);
           
           // 保存件数に上限を設定（例：最新50件まで保存）
           if (history.length > 50) {
             history = history.slice(0, 50);
           }
           
           // JSON形式で localStorage に保存
           localStorage.setItem('watchHistory', JSON.stringify(history));
         }
         
         // ページ読み込み時に履歴に登録
         window.addEventListener('load', addToHistory);
       </script>
       
       
   </body>
 </html>
